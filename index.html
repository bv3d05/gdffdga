-- ===== Fixed Aura HTML DUI Menu System =====

-- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
local AuraDUI = {
    dui = nil,
    duiHandle = nil,
    txd = nil,
    texture = nil,
    isVisible = false,
    authenticated = false,
    currentCategory = nil
}

-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù†ÙŠÙˆ Ø§Ù„Ù…ÙØµØ­Ø­Ø©
local MENU_CONFIG = {
    -- Ø§Ø³ØªØ®Ø¯Ù… GitHub Pages Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† raw
    url = "https://wf-675.github.io/Aura-Api-Menu/index.html",
    -- Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… HTMLPreview ÙƒØ¨Ø¯ÙŠÙ„
    -- url = "https://htmlpreview.github.io/?https://github.com/wf-675/Aura-Api-Menu/blob/main/index.html",
    width = 800,  -- Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶
    height = 600, -- Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹
    posX = 0.5,   -- ÙˆØ³Ø· Ø§Ù„Ø´Ø§Ø´Ø©
    posY = 0.5,   -- ÙˆØ³Ø· Ø§Ù„Ø´Ø§Ø´Ø©
    scaleX = 0.45, -- ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø¹Ø±Ø¶
    scaleY = 0.55  -- ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø§Ø±ØªÙØ§Ø¹
}

-- ===== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙØ­Ø³Ù†Ø© =====

-- Ø¥Ù†Ø´Ø§Ø¡ DUI Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ø®Ø·Ø§Ø¡
function CreateAuraDUI()
    print("Creating Aura DUI...")
    print("Loading from URL: " .. MENU_CONFIG.url)
    
    -- ØªØ¯Ù…ÙŠØ± DUI Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¥Ù† ÙˆØ¬Ø¯
    if AuraDUI.dui then
        DestroyAuraDUI()
        Wait(100)
    end
    
    -- Ø¥Ù†Ø´Ø§Ø¡ DUI Ù…Ù† Ø±Ø§Ø¨Ø· HTML
    AuraDUI.dui = CreateDui(MENU_CONFIG.url, MENU_CONFIG.width, MENU_CONFIG.height)
    
    if not AuraDUI.dui then
        print("âŒ Failed to create DUI - Check URL")
        return false
    end
    
    -- Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ DUI
    Wait(1000)
    
    -- Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ handle
    AuraDUI.duiHandle = GetDuiHandle(AuraDUI.dui)
    
    if not AuraDUI.duiHandle then
        print("âŒ Failed to get DUI handle")
        DestroyDui(AuraDUI.dui)
        AuraDUI.dui = nil
        return false
    end
    
    -- Ø¥Ù†Ø´Ø§Ø¡ texture dictionary
    AuraDUI.txd = CreateRuntimeTxd("aura_menu_txd")
    
    if not AuraDUI.txd then
        print("âŒ Failed to create texture dictionary")
        return false
    end
    
    -- Ø¥Ù†Ø´Ø§Ø¡ texture Ù…Ù† DUI
    AuraDUI.texture = CreateRuntimeTextureFromDuiHandle(AuraDUI.txd, "aura_menu_tex", AuraDUI.duiHandle)
    
    if not AuraDUI.texture then
        print("âŒ Failed to create texture from DUI")
        return false
    end
    
    print("âœ… Aura DUI created successfully")
    AuraDUI.isVisible = true
    
    -- Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„Ù€ HTML
    Wait(2000)
    SendMessageToDUI({
        type = "system_ready",
        message = "DUI System Ready"
    })
    
    return true
end

-- ØªØ¯Ù…ÙŠØ± DUI
function DestroyAuraDUI()
    if AuraDUI.dui then
        DestroyDui(AuraDUI.dui)
        AuraDUI.dui = nil
        AuraDUI.duiHandle = nil
        AuraDUI.texture = nil
        AuraDUI.txd = nil
        AuraDUI.isVisible = false
        print("Aura DUI destroyed")
    end
end

-- Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù€ HTML
function SendMessageToDUI(message)
    if AuraDUI.dui then
        local success = SendDuiMessage(AuraDUI.dui, json.encode(message))
        if success then
            print("ğŸ“¤ Message sent to DUI: " .. message.type)
        else
            print("âŒ Failed to send message to DUI")
        end
    else
        print("âŒ Cannot send message - DUI not available")
    end
end

-- Ù…Ø¹Ø§Ù„Ø¬ Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† HTML
function HandleDUIMessage(data)
    print("ğŸ“¥ Received DUI message: " .. (data.type or "unknown"))
    
    if data.type == "aura_authenticated" then
        AuraDUI.authenticated = true
        print("âœ… Authentication successful for key: " .. (data.key or "unknown"))
        TriggerEvent('chatMessage', 'Aura', {0, 255, 0}, 'Authentication successful!')
        
    elseif data.type == "aura_category_selected" then
        AuraDUI.currentCategory = data.category
        print("ğŸ“‚ Category selected: " .. data.category)
        HandleCategorySelection(data.category)
        
    elseif data.type == "aura_option_selected" then
        print("âš¡ Option selected: " .. (data.option or "unknown"))
        print("working")
        TriggerEvent('chatMessage', 'Aura', {255, 255, 0}, (data.option or "Option") .. " - working!")
        
    elseif data.type == "aura_error" then
        print("âŒ HTML Error: " .. (data.message or "unknown error"))
        
    elseif data.type == "aura_ready" then
        print("âœ… HTML interface ready")
        TriggerEvent('chatMessage', 'Aura', {0, 255, 255}, 'Menu interface loaded!')
    end
end

-- Ù…Ø¹Ø§Ù„Ø¬ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ¦Ø§Øª
function HandleCategorySelection(category)
    if not AuraDUI.authenticated then
        print("âŒ User not authenticated")
        TriggerEvent('chatMessage', 'Aura', {255, 0, 0}, 'Authentication required!')
        return
    end
    
    TriggerEvent('chatMessage', 'Aura', {100, 200, 255}, 'Category: ' .. category)
    
    -- ØªÙ†ÙÙŠØ° Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    if category == "self" then
        print("ğŸ‘¤ Opening player options...")
        
    elseif category == "online" then
        print("ğŸŒ Opening online players menu...")
        
    elseif category == "weapons" then
        print("ğŸ”« Opening weapons menu...")
        
    elseif category == "visual" then
        print("ğŸ‘ï¸ Opening visual effects...")
        
    elseif category == "vehicle" then
        print("ğŸš— Opening vehicle options...")
        
    elseif category == "world" then
        print("ğŸŒ Opening world options...")
        
    elseif category == "misc" then
        print("ğŸ“¦ Opening miscellaneous...")
        
    elseif category == "settings" then
        print("âš™ï¸ Opening settings...")
    end
end

-- ===== Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ­ÙƒÙ… =====

-- ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ÙŠÙˆ
function ToggleAuraMenu()
    if AuraDUI.isVisible then
        AuraDUI.isVisible = false
        print("Menu hidden")
        TriggerEvent('chatMessage', 'Aura', {255, 165, 0}, 'Menu hidden')
    else
        if not AuraDUI.dui then
            CreateAuraDUI()
        end
        AuraDUI.isVisible = true
        print("Menu shown")
        TriggerEvent('chatMessage', 'Aura', {0, 255, 0}, 'Menu shown')
    end
end

-- Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ÙŠÙˆ
function ReloadAuraMenu()
    print("ğŸ”„ Reloading Aura Menu...")
    DestroyAuraDUI()
    Wait(500)
    CreateAuraDUI()
    TriggerEvent('chatMessage', 'Aura', {255, 255, 0}, 'Menu reloaded!')
end

-- ===== Thread Ø§Ù„Ø±Ø³Ù… =====

CreateThread(function()
    -- Ø¥Ù†Ø´Ø§Ø¡ DUI Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø¡
    Wait(2000) -- Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
    CreateAuraDUI()
    
    while true do
        Wait(0)
        
        -- Ø±Ø³Ù… DUI Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
        if AuraDUI.isVisible and AuraDUI.txd and AuraDUI.texture then
            DrawSprite("aura_menu_txd", "aura_menu_tex", 
                      MENU_CONFIG.posX, MENU_CONFIG.posY, 
                      MENU_CONFIG.scaleX, MENU_CONFIG.scaleY, 
                      0.0, 255, 255, 255, 255)
        end
    end
end)

-- ===== Thread Ø§Ù„ØªØ­ÙƒÙ… =====

CreateThread(function()
    while true do
        Wait(0)
        
        -- ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ÙŠÙˆ Ø¨Ù€ F1
        if IsControlJustPressed(0, 288) then -- F1
            ToggleAuraMenu()
        end
        
        -- Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨Ù€ F2
        if IsControlJustPressed(0, 289) then -- F2
            ReloadAuraMenu()
        end
        
        -- Ø¥Ø®ÙØ§Ø¡ Ø¨Ù€ ESC
        if IsControlJustPressed(0, 322) and AuraDUI.isVisible then -- ESC
            AuraDUI.isVisible = false
            TriggerEvent('chatMessage', 'Aura', {255, 165, 0}, 'Menu hidden')
        end
    end
end)

-- ===== Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« =====

-- Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† HTML
RegisterNUICallback('messageHandler', function(data, cb)
    HandleDUIMessage(data)
    cb('ok')
end)

-- Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø§Øª
RegisterCommand('aura', function()
    ToggleAuraMenu()
end, false)

RegisterCommand('aurareload', function()
    ReloadAuraMenu()
end, false)

RegisterCommand('auraurl', function(source, args)
    if args[1] then
        MENU_CONFIG.url = args[1]
        print("URL updated to: " .. args[1])
        ReloadAuraMenu()
    else
        print("Current URL: " .. MENU_CONFIG.url)
        TriggerEvent('chatMessage', 'Aura', {255, 255, 0}, 'URL: ' .. MENU_CONFIG.url)
    end
end, false)

-- ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù€ resource
AddEventHandler('onResourceStop', function(resourceName)
    if (GetCurrentResourceName() ~= resourceName) then
        return
    end
    
    DestroyAuraDUI()
end)

-- Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¨Ø¯Ø¡
print("==============================")
print("FIXED AURA HTML DUI MENU")
print("URL: " .. MENU_CONFIG.url)
print("Controls:")
print("F1: Toggle Menu")
print("F2: Reload Menu") 
print("ESC: Hide Menu")
print("Commands: /aura /aurareload /auraurl")
print("==============================")

-- ÙØ­Øµ Ø­Ø§Ù„Ø© DUI
CreateThread(function()
    Wait(5000)
    if AuraDUI.isVisible and AuraDUI.dui then
        print("âœ… Aura DUI is running successfully")
        TriggerEvent('chatMessage', 'Aura', {0, 255, 0}, 'DUI System Ready!')
    else
        print("âŒ Aura DUI failed to load - Try /aurareload")
        TriggerEvent('chatMessage', 'Aura', {255, 0, 0}, 'DUI Load Failed - Try F2 or /aurareload')
    end
end)
